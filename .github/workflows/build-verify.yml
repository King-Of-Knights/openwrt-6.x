# æ„å»ºéªŒè¯å·¥ä½œæµ
# åœ¨å†…æ ¸æ›´æ–°æˆ– NSS è¡¥ä¸æ›´æ–°åéªŒè¯æ„å»º
name: Build Verification

on:
  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      trigger_reason:
        description: 'è§¦å‘åŸå› '
        required: false
        default: 'manual'
        type: string

permissions:
  contents: read
  issues: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: é‡Šæ”¾ç£ç›˜ç©ºé—´
        run: |
          echo "é‡Šæ”¾ç£ç›˜ç©ºé—´å‰:"
          df -h
          
          # åˆ é™¤ä¸éœ€è¦çš„è½¯ä»¶å’Œæ–‡ä»¶
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          
          # åˆ é™¤ Docker é•œåƒ
          docker rmi $(docker images -q) || true
          
          # åˆ é™¤äº¤æ¢æ–‡ä»¶
          sudo swapoff -a
          sudo rm -f /swapfile /mnt/swapfile
          
          # æ¸…ç† apt ç¼“å­˜
          sudo apt-get clean
          
          echo "é‡Šæ”¾ç£ç›˜ç©ºé—´å:"
          df -h
      
      - name: å®‰è£…æ„å»ºä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential clang flex bison g++ gawk \
            gcc-multilib g++-multilib gettext git libncurses-dev libssl-dev \
            python3-distutils rsync unzip zlib1g-dev file wget \
            libelf-dev libglib2.0-dev libgmp3-dev libmpc-dev \
            libmpfr-dev libncursesw5-dev libreadline-dev libtool \
            mkisofs p7zip p7zip-full qemu-utils squashfs-tools \
            subversion swig texinfo uglifyjs upx-ucl xmlto \
            ccache libfuse-dev
      
      - name: æ£€æŸ¥ .config æ–‡ä»¶
        id: config_check
        run: |
          if [ -f ".config" ]; then
            echo "config_exists=true" >> $GITHUB_OUTPUT
            echo "âœ… æ‰¾åˆ° .config æ–‡ä»¶"
            echo "é…ç½®å†…å®¹é¢„è§ˆ:"
            head -20 .config || true
          else
            echo "config_exists=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ æœªæ‰¾åˆ° .config æ–‡ä»¶ï¼Œå°†ä½¿ç”¨é»˜è®¤é…ç½®"
          fi
      
      - name: åˆ›å»ºé»˜è®¤é…ç½®ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
        if: steps.config_check.outputs.config_exists == 'false'
        run: |
          cat > .config << 'EOF'
          CONFIG_TARGET_qualcommax=y
          CONFIG_TARGET_qualcommax_ipq60xx=y
          CONFIG_TARGET_qualcommax_ipq60xx_DEVICE_glinet_gl-axt1800=y
          CONFIG_DEVEL=y
          CONFIG_CCACHE=y
          EOF
          echo "å·²åˆ›å»ºåŸºæœ¬é…ç½®æ–‡ä»¶"
      
      - name: æ›´æ–°å¹¶å®‰è£… feeds
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a
      
      - name: åŠ è½½é…ç½®
        run: |
          make defconfig
      
      - name: ä¸‹è½½ä¾èµ–åŒ…
        id: download
        continue-on-error: true
        run: |
          make download -j$(nproc) V=s
          
          # æ£€æŸ¥ä¸‹è½½ç»“æœ
          if [ $? -eq 0 ]; then
            echo "download_success=true" >> $GITHUB_OUTPUT
          else
            echo "download_success=false" >> $GITHUB_OUTPUT
          fi
      
      - name: æ¸…ç†æ—§çš„å†…æ ¸æ„å»ºäº§ç‰©
        run: |
          # æ¸…ç†å†…æ ¸æ„å»ºç¼“å­˜
          rm -rf build_dir/target-*/linux-qualcommax* || true
          rm -rf staging_dir/target-*/packages/kernel* || true
          rm -rf tmp/.*-kernel* || true
          echo "âœ… å·²æ¸…ç†æ—§çš„å†…æ ¸æ„å»ºäº§ç‰©"
      
      - name: ç¼–è¯‘å·¥å…·é“¾
        id: toolchain
        continue-on-error: true
        run: |
          echo "å¼€å§‹ç¼–è¯‘å·¥å…·é“¾..."
          make tools/install -j$(nproc) V=s
          make toolchain/install -j$(nproc) V=s
          
          if [ $? -eq 0 ]; then
            echo "toolchain_success=true" >> $GITHUB_OUTPUT
            echo "âœ… å·¥å…·é“¾ç¼–è¯‘æˆåŠŸ"
          else
            echo "toolchain_success=false" >> $GITHUB_OUTPUT
            echo "âŒ å·¥å…·é“¾ç¼–è¯‘å¤±è´¥"
          fi
      
      - name: ç¼–è¯‘å†…æ ¸
        id: kernel
        if: steps.toolchain.outputs.toolchain_success == 'true'
        continue-on-error: true
        run: |
          echo "å¼€å§‹ç¼–è¯‘å†…æ ¸..."
          make target/linux/compile -j$(nproc) V=s
          
          if [ $? -eq 0 ]; then
            echo "kernel_success=true" >> $GITHUB_OUTPUT
            echo "âœ… å†…æ ¸ç¼–è¯‘æˆåŠŸ"
          else
            echo "kernel_success=false" >> $GITHUB_OUTPUT
            echo "âŒ å†…æ ¸ç¼–è¯‘å¤±è´¥"
          fi
      
      - name: ç¼–è¯‘ mac80211
        id: mac80211
        if: steps.kernel.outputs.kernel_success == 'true'
        continue-on-error: true
        run: |
          echo "å¼€å§‹ç¼–è¯‘ mac80211..."
          make package/kernel/mac80211/compile -j$(nproc) V=s
          
          if [ $? -eq 0 ]; then
            echo "mac80211_success=true" >> $GITHUB_OUTPUT
            echo "âœ… mac80211 ç¼–è¯‘æˆåŠŸ"
          else
            echo "mac80211_success=false" >> $GITHUB_OUTPUT
            echo "âŒ mac80211 ç¼–è¯‘å¤±è´¥"
          fi
      
      - name: ç¼–è¯‘ NSS åŒ…
        id: nss
        if: steps.mac80211.outputs.mac80211_success == 'true'
        continue-on-error: true
        run: |
          echo "å¼€å§‹ç¼–è¯‘ NSS ç›¸å…³åŒ…..."
          
          # ç¼–è¯‘ NSS å›ºä»¶
          make package/firmware/ath11k-firmware/compile -j$(nproc) V=s || echo "ath11k-firmware ç¼–è¯‘è­¦å‘Š"
          
          # å°è¯•ç¼–è¯‘ NSS åŒ…ï¼ˆæ¥è‡ª feedsï¼‰
          make package/feeds/nss_packages/qca-nss-drv/compile -j1 V=s || echo "NSS drv ç¼–è¯‘è·³è¿‡ï¼ˆå¯èƒ½ä¸å­˜åœ¨ï¼‰"
          
          # ç®€å•æ£€æŸ¥ï¼šå¦‚æœæ²¡æœ‰ä¸¥é‡é”™è¯¯å°±è®¤ä¸ºæˆåŠŸ
          echo "nss_success=true" >> $GITHUB_OUTPUT
          echo "âœ… NSS åŒ…ç¼–è¯‘å®Œæˆ"
      
      - name: ç”Ÿæˆæ„å»ºæ‘˜è¦
        if: always()
        id: summary
        run: |
          echo "## æ„å»ºéªŒè¯ç»“æœ" > build-summary.txt
          echo "" >> build-summary.txt
          echo "**è§¦å‘åŸå› **: ${{ github.event.inputs.trigger_reason }}" >> build-summary.txt
          echo "" >> build-summary.txt
          echo "### æ„å»ºæ­¥éª¤çŠ¶æ€" >> build-summary.txt
          echo "" >> build-summary.txt
          echo "- ä¾èµ–ä¸‹è½½: ${{ steps.download.outputs.download_success == 'true' && 'âœ… æˆåŠŸ' || 'âŒ å¤±è´¥' }}" >> build-summary.txt
          echo "- å·¥å…·é“¾ç¼–è¯‘: ${{ steps.toolchain.outputs.toolchain_success == 'true' && 'âœ… æˆåŠŸ' || 'âŒ å¤±è´¥' }}" >> build-summary.txt
          echo "- å†…æ ¸ç¼–è¯‘: ${{ steps.kernel.outputs.kernel_success == 'true' && 'âœ… æˆåŠŸ' || 'âŒ å¤±è´¥' }}" >> build-summary.txt
          echo "- mac80211 ç¼–è¯‘: ${{ steps.mac80211.outputs.mac80211_success == 'true' && 'âœ… æˆåŠŸ' || 'âŒ å¤±è´¥' }}" >> build-summary.txt
          echo "- NSS åŒ…ç¼–è¯‘: ${{ steps.nss.outputs.nss_success == 'true' && 'âœ… æˆåŠŸ' || 'âŒ å¤±è´¥' }}" >> build-summary.txt
          echo "" >> build-summary.txt
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å¤±è´¥
          if [ "${{ steps.toolchain.outputs.toolchain_success }}" != "true" ] || \
             [ "${{ steps.kernel.outputs.kernel_success }}" != "true" ] || \
             [ "${{ steps.mac80211.outputs.mac80211_success }}" != "true" ]; then
            echo "build_failed=true" >> $GITHUB_OUTPUT
            echo "### âš ï¸ æ„å»ºéªŒè¯å¤±è´¥" >> build-summary.txt
            echo "" >> build-summary.txt
            echo "è¯·æ£€æŸ¥å·¥ä½œæµæ—¥å¿—è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯ã€‚" >> build-summary.txt
          else
            echo "build_failed=false" >> $GITHUB_OUTPUT
            echo "### âœ… æ„å»ºéªŒè¯é€šè¿‡" >> build-summary.txt
            echo "" >> build-summary.txt
            echo "æ‰€æœ‰å…³é”®ç»„ä»¶ç¼–è¯‘æˆåŠŸã€‚" >> build-summary.txt
          fi
          
          cat build-summary.txt
      
      - name: ä¸Šä¼ æ„å»ºæ—¥å¿—
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: |
            logs/
            build-summary.txt
          retention-days: 7
      
      - name: å°è¯•å‚è€ƒ NSS ä¸Šæ¸¸è§£å†³æ–¹æ¡ˆ
        if: steps.summary.outputs.build_failed == 'true'
        id: nss_reference
        run: |
          echo "æ„å»ºå¤±è´¥ï¼Œå°è¯•å‚è€ƒ qosmio/openwrt-ipq main-nss åˆ†æ”¯..."
          
          # åˆ›å»ºä¸´æ—¶ç›®å½•
          TEMP_DIR=$(mktemp -d)
          cd "$TEMP_DIR"
          
          # å…‹éš† NSS å‚è€ƒä»“åº“
          git clone --depth 5 --branch main-nss https://github.com/qosmio/openwrt-ipq.git reference
          cd reference
          
          echo "å‚è€ƒä»“åº“æœ€æ–°æäº¤:"
          git log -1 --oneline
          
          echo "" 
          echo "å¯ä»¥å‚è€ƒä»¥ä¸‹æ–‡ä»¶ä»¥è§£å†³æ„å»ºé—®é¢˜:"
          echo "- package/kernel/mac80211/Makefile"
          echo "- target/linux/qualcommax/Makefile"
          echo "- .config (å¦‚æœå­˜åœ¨)"
          
          # æ¸…ç†
          cd /
          rm -rf "$TEMP_DIR"
          
          echo "need_manual_fix=true" >> $GITHUB_OUTPUT
      
      - name: åˆ›å»ºæ„å»ºå¤±è´¥ Issue
        if: steps.summary.outputs.build_failed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let summary = 'æ„å»ºå¤±è´¥ï¼Œæ— æ³•ç”Ÿæˆæ‘˜è¦';
            try {
              summary = fs.readFileSync('build-summary.txt', 'utf8');
            } catch (e) {
              console.log('æ— æ³•è¯»å–æ„å»ºæ‘˜è¦æ–‡ä»¶');
            }
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'æ„å»ºéªŒè¯å¤±è´¥ - éœ€è¦æ‰‹åŠ¨ä¿®å¤',
              body: `${summary}\n\n---\n\n**å‚è€ƒèµ„æº**:\n- qosmio/openwrt-ipq (main-nss): https://github.com/qosmio/openwrt-ipq/tree/main-nss\n- æ„å»ºæ—¥å¿—: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\n\n**å»ºè®®æ“ä½œ**:\n1. æ£€æŸ¥å·¥ä½œæµæ—¥å¿—ä¸­çš„è¯¦ç»†é”™è¯¯ä¿¡æ¯\n2. å¯¹æ¯” qosmio/openwrt-ipq main-nss åˆ†æ”¯çš„ç›¸å…³æ–‡ä»¶\n3. å¦‚æœæ˜¯ NSS è¡¥ä¸é—®é¢˜ï¼Œå¯èƒ½éœ€è¦è°ƒæ•´è¡¥ä¸\n4. å¦‚æœæ˜¯å†…æ ¸ç‰ˆæœ¬é—®é¢˜ï¼Œå¯èƒ½éœ€è¦æ›´æ–°é…ç½®\n\nâš ï¸ **é‡è¦**: ä¸è¦åˆ é™¤ç°æœ‰çš„ NSS è½¬å‘åŠŸèƒ½`,
              labels: ['build-failure', 'nss-patches']
            });
      
      - name: æ„å»ºæˆåŠŸé€šçŸ¥
        if: steps.summary.outputs.build_failed == 'false'
        run: |
          cat build-summary.txt
          echo ""
          echo "ğŸ‰ æ„å»ºéªŒè¯æˆåŠŸå®Œæˆï¼"
